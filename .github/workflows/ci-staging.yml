name: 1. CI

on:
  push:
    branches: ["main"]

jobs:
  test-build-deploy-staging:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # --- TEST PHASE (Giữ nguyên) ---
      - name: Start Containers & Test Backend
        run: |
          docker compose -f docker-compose.ci.yml up -d --build --force-recreate
          sleep 60
          curl --fail http://localhost:8080/health || exit 1
      
      - name: Test Frontend Build
        run: |
          cd frontend
          npm install
          chmod +x node_modules/.bin/vite  
          npm run build
      
      - name: Stop Containers
        run: docker compose -f docker-compose.ci.yml down

      - name: Debug Container Logs
        if: failure()
        run: |
          echo "=== LOG BACKEND ==="
          docker compose -f docker-compose.ci.yml logs backend
          
          echo "=== LOG FRONTEND ==="
          docker compose -f docker-compose.ci.yml logs frontend
      
      # --- BUILD & PUSH PHASE (Thay đổi cho AWS ECR) ---
      
      # 1. Cấu hình credentials AWS để có quyền truy cập
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # 2. Đăng nhập vào ECR (Bước này sẽ output ra registry URL)
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # 3. Build & Push Backend
      - name: Build & Push Backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          # ${{ steps.login-ecr.outputs.registry }} sẽ tự động lấy URL ECR của bạn
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/resume/backend:staging
            ${{ steps.login-ecr.outputs.registry }}/resume/backend:${{ github.sha }}

      # 4. Build & Push Frontend
      - name: Build & Push Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/resume/frontend:staging
            ${{ steps.login-ecr.outputs.registry }}/resume/frontend:${{ github.sha }}
